中間試験　Rails　課題２
今日は検索formでこのようなエラーと出会った。
  NoMethodError in PostsController#index
  undefined method `type' for nil:NilClass
  Extracted source (around line #19):

ログを確認すると、このような記述。
  attr.klass.columns.find { |column| column.name == name }.type

原因はformのuser検索に、user_nameとしていたこと。
usersテーブルには、nameカラムが無く、profileテーブルにnameカラムがあった。
カラムがないので、上記のようなエラーが発生した。
そもそも、テーブルのカラムを確認していなかった自分が悪いのだが。
よって、postsテーブルとprofilesテーブルのアソシエーションを定義することとなった。
しかし、両テーブルにはフォーリンキーが無く、usersテーブルを中継する必要があった。

自分は初め、このようなアソシエーションを記述した

postのmodel
  belongs_to :profile

profileのmodel
  has_many :posts, through: :user

postのmodelが誤りであり、正しくは
  has_one :profile, through: :user
のように、userを中継しなくてはならない。

加えて、usersのmodelについても
  has_many :posts
  has_one :profile
という関連付けをしておく必要がある。

しかし、まだエラーは消えず

NoMethodError in Posts#index
Showing /app/app/views/shared/_search_form.html.erb where line #4 raised:

undefined method `profiles_name_cont' for Ransack::Search<class: Post, base: Grouping <combinator: and>>:Ransack::Search
Extracted source (around line #4):

<%= f.search_field :title_or_body_cont, placeholder: "投稿", id:"search_field_of_post"%>
<%= f.search_field :comments_body_cont, placeholder: "コメン"id"search_field_of_comment"%>
<%= f.search_field :profiles_name_cont, placeholder: "ユーザー",id:"search_field_of_user"%>
<%= f.submit%>
<% end %>

このエラーの解決は単純で、コンソールでアソシエーションを確認すると

rb(main):002:0> Post.ransackable_associations
=> ["profile", "comments"]

となっていた。
つまり、profileではなく、profilesというように複数形にしていたから、アソシエーションされていないと判断され、エラーが発生したものであった。


明日は、N + 1 問題が発生しているので、その解決と、検索結果を表示するビューの実装を行いたい。